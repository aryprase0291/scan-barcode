<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Inventori</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

    <div class="navbar">
        <div class="brand">MY INVENTORY</div>
        <div style="font-size:12px; color:#666;">v2.0</div>
    </div>

    <div class="menu-toggle">
        <button class="menu-btn active" onclick="setMode('scan')">Scan Biasa</button>
        <button class="menu-btn" onclick="setMode('master')">Input Master</button>
    </div>

    <div class="scanner-container">
    <div id="reader"></div>
    
    <div id="success-anim" class="scan-overlay">
        <div class="success-icon">✅</div> </div>
</div>

    <div id="form-master-panel" class="form-master">
        <h3 style="margin-top:0;">Input Data Barang Baru</h3>
        
        <div class="form-group">
            <label class="form-label">ID Barcode (Scan Otomatis)</label>
            <input type="text" id="inp_barcode" class="form-input" placeholder="Scan barang..." readonly style="background:#e9ecef;">
        </div>

        <div class="form-group">
            <label class="form-label">Nama Barang</label>
            <input type="text" id="inp_nama" class="form-input" placeholder="Contoh: Kampas Rem Vario">
        </div>

        <div class="form-group">
            <label class="form-label">Satuan</label>
            <select id="inp_satuan" class="form-input">
                <option value="PCS">PCS</option>
                <option value="SET">SET</option>
                <option value="BOX">BOX</option>
                <option value="UNIT">UNIT</option>
                <option value="LITER">LITER</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Keterangan / Lokasi Rak</label>
            <input type="text" id="inp_ket" class="form-input" placeholder="Contoh: Rak A-1">
        </div>

        <button class="btn-save" onclick="simpanMaster()">SIMPAN DATA</button>
    </div>

    <div id="status-msg">Siap Scan...</div>

    <script>
        // --- GANTI URL INI DENGAN YANG BARU ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwhfG7p5lzS2t4CsNPiHULhDYHrOS43Gr_M3VIXKcGna7zuN-OQmAB3aGNioKhOBlp1Vw/exec";

        let currentMode = 'scan'; // 'scan' atau 'master'
        let html5QrcodeScanner;

        function setMode(mode) {
            currentMode = mode;
            // Update UI Tombol
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            // Tampilkan/Sembunyikan Form
            if(mode === 'master') {
                document.getElementById('form-master-panel').style.display = 'block';
                showToast("Mode Input Master: Silakan Scan Barang");
            } else {
                document.getElementById('form-master-panel').style.display = 'none';
                showToast("Mode Scan Biasa Aktif");
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Bunyi Beep
            if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(200);

            if (currentMode === 'scan') {
                // LOGIKA SCAN BIASA
                html5QrcodeScanner.pause(); // Pause sebentar
                kirimData({ action: 'scan_biasa', barcode: decodedText });
            } 
            else if (currentMode === 'master') {
                // LOGIKA INPUT MASTER
                // Isi otomatis kolom barcode, tapi JANGAN kirim dulu
                document.getElementById('inp_barcode').value = decodedText;
                showToast("Barcode Terbaca! Silakan isi detail.");
                html5QrcodeScanner.pause(); // Pause biar user bisa ngetik tenang
                
                // Scroll ke form
                document.getElementById('form-master-panel').scrollIntoView({behavior: "smooth"});
            }
        }

        function simpanMaster() {
            const barcode = document.getElementById('inp_barcode').value;
            const nama = document.getElementById('inp_nama').value;
            const satuan = document.getElementById('inp_satuan').value;
            const ket = document.getElementById('inp_ket').value;

            if(!barcode || !nama) {
                alert("Barcode dan Nama Barang wajib diisi!");
                return;
            }

            const payload = {
                action: 'input_master',
                barcode: barcode,
                nama: nama,
                satuan: satuan,
                keterangan: ket
            };

            kirimData(payload);
        }

        function kirimData(jsonData) {
            showToast("Mengirim data...", true);

            fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(jsonData)
            }).then(() => {
                // 1. Update Toast
                showToast("✅ Berhasil!", true);
                
                // 2. Mainkan Efek Getar (Haptic) - Pola: Getar pendek 2x
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate([100, 50, 100]); 
                }

                // 3. TAMPILKAN ANIMASI LAYAR
                const overlay = document.getElementById('success-anim');
                overlay.classList.add('active');

                // 4. Timer untuk Refresh Kamera
                setTimeout(() => {
                    // Hilangkan animasi
                    overlay.classList.remove('active');
                    
                    if (currentMode === 'master') {
                        // Reset Form Master
                        document.getElementById('inp_barcode').value = "";
                        document.getElementById('inp_nama').value = "";
                        document.getElementById('inp_ket').value = "";
                        html5QrcodeScanner.resume(); 
                    } else {
                        // MODE SCAN BIASA: Refresh Kamera (Resume)
                        html5QrcodeScanner.resume(); 
                        showToast("Siap Scan Berikutnya...");
                    }
                }, 1500); // Animasi tampil selama 1.5 detik

            }).catch(err => {
                showToast("❌ Gagal Kirim");
                console.error(err);
                // Jika gagal, tetap nyalakan kamera biar bisa coba lagi
                setTimeout(() => { html5QrcodeScanner.resume(); }, 1000);
            });
        }

        function showToast(text, persistent = false) {
            const el = document.getElementById('status-msg');
            el.innerText = text;
            el.classList.add('show-toast');
            if(!persistent) {
                setTimeout(() => el.classList.remove('show-toast'), 3000);
            }
        }

        // Init Scanner
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { fps: 20, qrbox: {width: 250, height: 250}, experimentalFeatures: { useBarCodeDetectorIfSupported: true } },
            false
        );
        html5QrcodeScanner.render(onScanSuccess, (err)=>{});

    </script>
</body>
</html>